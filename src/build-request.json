{
  "kind": "build_request",
  "title": "Version 10 Final Build: Smart Tick ID, Environment-Aware Start, System Ready Guard, and Timer Failure Notifications",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-4",
      "text": "Backend: Add a persistent `last_update_id` tick counter for the live price sampling buffer, and increment `last_update_id` ONLY when a valid live price sample is successfully fetched and stored in the ring buffer (do not increment on timer ticks that fail, return invalid data, or do not result in a buffer write). Expose a query API to read `last_update_id` for frontend synchronization.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Smart ID Increment: Update last_update_id ONLY when a valid price is successfully fetched and stored in the buffer."
        ]
      },
      "acceptanceCriteria": [
        "A new backend query returns the current `last_update_id`.",
        "`last_update_id` increases by exactly 1 only when a live sample is validated and written to the buffer.",
        "If a live fetch fails or produces invalid price data and the buffer is not updated, `last_update_id` does not change."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Backend: Implement Smart Start logic for `startAgent` based on environment. If Environment == Mainnet: `startAgent` must force Live Data Source = ON and start the 10-second timer (and trigger an immediate initial fetch). If Environment == Dev: `startAgent` must respect the current Live Data Source toggle state but still ensure the 10-second timer is running (and trigger an immediate initial fetch if the live source is ON).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Smart Start Logic: > - If Environment == Mainnet: Start Agent forces Live_Data_Source = ON and starts the Timer.\n\nIf Environment == Dev: Start Agent respects current toggle but ensures Timer is running."
        ]
      },
      "acceptanceCriteria": [
        "On Mainnet, calling `startAgent` results in Live Data Source being enabled and the timer running, regardless of prior toggle state.",
        "On Dev, calling `startAgent` does not override the Live Data Source enabled/disabled setting, but does ensure the timer is running.",
        "On Mainnet, `startAgent` triggers an immediate initial fetch attempt as part of the start sequence."
      ]
    },
    {
      "id": "REQ-6",
      "text": "Backend + Frontend: Define Tri-State `System_Ready` as (is_Mainnet && is_Live_Source && is_Timer_Running). Expose these three booleans and the computed `systemReady` value in a backend status API that the frontend can poll. On the Dashboard (Market Watch page), display `System Ready` as a Green Shield icon when true (and a clearly \"not ready\" state when false). Use English for any user-facing labels/tooltips.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Tri-State Ready Guard: Define System_Ready as (is_Mainnet && is_Live_Source && is_Timer_Running). Display this as a 'Green Shield' icon on the Dashboard."
        ]
      },
      "acceptanceCriteria": [
        "Backend exposes `isMainnet`, `liveSourceEnabled`, `timerRunning`, and `systemReady` in a single status response.",
        "Dashboard shows a green shield icon only when all three conditions are true.",
        "Dashboard provides an English tooltip or label that explains which condition(s) are missing when not ready."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Backend + Frontend: Add timer start failure handling. If the 10-second timer fails to start (including any trap/error condition during the start attempt), return a failure result from the relevant backend call(s) and surface a persistent \"Canister Timeout\" warning in a Notification Center UI in the frontend (not only as a transient toast).",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Error Handling: If the 10s Timer fails to start, surface a 'Canister Timeout' warning in the Notification Center."
        ]
      },
      "acceptanceCriteria": [
        "Backend start flow detects and reports timer start failure without silently succeeding.",
        "Frontend renders a Notification Center area that lists active warnings.",
        "When timer start fails, a persistent warning labeled exactly \"Canister Timeout\" appears in the Notification Center until cleared or the condition is resolved."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Frontend: Update tick synchronization behavior to align UI refresh cadence with the backend 10-second timer by polling the backend `last_update_id` on a 10-second interval and using it as the source of truth for when to refresh tick-dependent widgets (including the 1-minute volatility chart) so the dashboard reflects the exact backend tick state.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Execute Version 10 Final Build with high-fidelity logic:"
        ]
      },
      "acceptanceCriteria": [
        "Frontend polls `last_update_id` every 10 seconds.",
        "Tick-dependent UI refreshes are keyed off changes to `last_update_id` (no extra intermediate refreshes that imply ticks that did not occur).",
        "The 1-minute volatility chart updates once per backend tick when live sampling is active."
      ]
    },
    {
      "id": "REQ-9",
      "text": "Finalize Version 10 for release: ensure candid/type definitions and React Query hooks are updated to match any backend API signature changes introduced by Version 10 (status APIs, last_update_id, start results), and ensure the app builds cleanly and is ready to deploy as \"Version 10\".",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Finalize and Deploy Version 10."
        ]
      },
      "acceptanceCriteria": [
        "Frontend compiles with no TypeScript errors after backend API changes.",
        "Backend compiles with no Motoko errors and candid matches frontend bindings.",
        "All new Version 10 behaviors (Smart ID increment, Smart Start logic, System Ready guard, Canister Timeout notification, 10s tick sync) are verifiable via the UI."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single-actor Motoko canister with all logic in backend/main.mo; add backend/migration.mo only if existing stable state requires migration.",
    "Do not edit any files under frontend/src/components/ui or any paths listed in frontend.immutablePaths.",
    "Use English for all user-facing text."
  ],
  "nonGoals": [
    "Implementing real trade execution (non-dry-run) is out of scope.",
    "Adding third-party authentication providers beyond Internet Identity is out of scope.",
    "Adding external databases or off-canister storage is out of scope."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}