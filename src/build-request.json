{
  "kind": "build_request",
  "title": "Version 11.1 Backend: Triangular Shadow Arbitrage Engine (100 ICP Notional, ICPSwap Pools)",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-7",
      "text": "Confirm the Version 11.1 triangular shadow simulation uses a fixed notional input amount of exactly 100 ICP as the starting asset for every run of the ICP → ckBTC → BOB → ICP path.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "仍然是 100 ICP"
        ]
      },
      "acceptanceCriteria": [
        "The backend triangular shadow simulation entry point uses 100 ICP as the default/fixed input amount (not configurable unless explicitly added later).",
        "A backend query/method (or the logged result payload) clearly indicates the run used 100 ICP as the input notional."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Implement Version 11.1 core triangular shadow arbitrage simulation in the single Motoko actor, using the strict ICPSwap pool route and pool IDs: xmiu5 (ICP/ckBTC) → 73nps (ckBTC/BOB) → sys7q (BOB/ICP). Use constant-product swap math (x*y=k) and apply a 0.3% fee per leg when computing expected outputs.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Path Mapping: Define legs using pool IDs: xmiu5 (ICP/ckBTC), 73nps (ckBTC/BOB), sys7q (BOB/ICP).",
          "Shadow Logic: Calculate expected output for 100 ICP using the $(x \\times y = k)$ formula, subtracting 0.3% fee per leg."
        ]
      },
      "acceptanceCriteria": [
        "A backend method exists to run the triangular shadow simulation and returns the per-leg outputs and the final virtual ICP output.",
        "The simulation applies 0.3% fee per leg in the output calculation for each swap leg.",
        "The simulation uses the exact pool IDs xmiu5, 73nps, sys7q for the forward path."
      ]
    },
    {
      "id": "REQ-9",
      "text": "Define and enforce Version 11.1 leg failure conditions in shadow mode: treat a leg as failed if either (a) pool data fetch fails for that leg, or (b) computed slippage for that leg exceeds 0.5%. When a failure happens at any leg, stop the forward path immediately and trigger Short-circuit Recovery.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Execution Logic: Simulate a 3-step swap. Trigger Short-circuit Recovery if slippage exceeds 0.5% or pool data fetch fails.",
          "Safety Parameters: Enforce a 0.5% max slippage."
        ]
      },
      "acceptanceCriteria": [
        "If pool data cannot be fetched for any required pool during the run, the simulation terminates the forward path and enters recovery.",
        "If computed slippage for any leg is > 0.5%, the simulation terminates the forward path and enters recovery.",
        "The returned result indicates which leg failed and why (fetch failure vs slippage breach), even though only net P/L is persisted to the Lab log."
      ]
    },
    {
      "id": "REQ-10",
      "text": "Implement the Version 11.1 Short-circuit Recovery simulator: when a forward leg fails, simulate swapping remaining virtual assets back to ICP using the most liquid direct pool chosen by 1-minute moving average TVL. Use xmiu5 as the ckBTC/ICP fallback pool and ybilh as the BOB/ICP fallback pool. Liquidity selection must be based on the 1-minute moving average TVL computed from existing ring-buffer snapshots (do not introduce a new TVL buffer if ring-buffer data already exists).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Recovery Path: Use pool ybilh for BOB/ICP fallback and xmiu5 for ckBTC/ICP fallback based on 1-minute MA TVL.",
          "Resource Management: Calculate 1-minute MA TVL directly from existing ring-buffer snapshots."
        ]
      },
      "acceptanceCriteria": [
        "On any forward-path failure, the backend produces a recovered final virtual ICP balance by simulating a direct swap via either xmiu5 or ybilh (depending on which remaining asset must be converted back to ICP).",
        "The recovery logic chooses between the two direct pools based on a 1-minute moving average TVL derived from existing stored ring-buffer snapshot data.",
        "The recovery simulation uses the exact fallback pool IDs: xmiu5 for ckBTC/ICP and ybilh for BOB/ICP."
      ]
    },
    {
      "id": "REQ-11",
      "text": "Minimal Evolutionary Lab logging for Version 11.1: persist only the final net virtual profit/loss (net shadow return) from each triangular shadow run to the existing Evolutionary Lab logging surface in the backend. Do not add per-leg status UI or the Path Visualizer in this version.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Shadow Result: Log only the virtual profit/loss to Evolutionary Lab.",
          "Skip UI Path Visualizer for now."
        ]
      },
      "acceptanceCriteria": [
        "Each triangular shadow run appends exactly one persisted record representing the final net virtual P/L (profit/loss) for the run.",
        "No additional per-leg logs are persisted as part of the Evolutionary Lab dataset for this feature.",
        "No frontend/UI requirements are introduced for a path visualizer in this build request."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor with all logic implemented in backend/main.mo (no additional backend services).",
    "Use English for any user-facing text exposed via APIs that the frontend might render (e.g., reason strings, status labels).",
    "Compute 1-minute moving average TVL from existing ring-buffer snapshot data; do not introduce a new dedicated TVL buffer if existing snapshots already provide the required history."
  ],
  "nonGoals": [
    "Do not implement real on-chain swaps (this is shadow/simulation only).",
    "Do not build the Execution-tab Path Visualizer UI in Version 11.1.",
    "Do not add third-party integrations or external databases."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}